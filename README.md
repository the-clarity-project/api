# API для clarity-project.info

Все методы API вызываются с помощью GET-запроса по URL http://clarity-project.info/api/*method* и возвращают ответ в формате JSON.

В заголовке **X-API-VERSION** возвращается версия API.

В случае ошибки, возвращается объект с единственным ключом **error**, содержащим подробности ошибки.

В каждом успешном запросе содержится объект **stats**, содержащий время его выполнения.

### Методы:
#### /edr.info/*ЕГРПОУ*
Возвращает информацию о ЕГРПОУ/ИНН.

Например: /api/edr.info/04526727

Поля: 
* **edr** и **name** - ЕГРПОУ и название;
* **address** - адрес;
   * **region_code** - распарсенный из строки код области;
* **contact** - контактное лицо;
* **isTenderer** - true если участвовал в закупках, false иначе;
* **isBuyer** - true если организовывал закупки;
* **history** - длина истории данных (см. [метод edr.history](#edrhistoryЕГРПОУ));
* **buyer_stats** - статистика закупщика. Отсутствует, если **isBuyer**=false;
   * **tenders** - количество и планируемая сумма всех органиованных тендеров;
   * **contracts** - количество и сумма подписанных контрактов;
* **tenderer_stats** - статистика учатника. Отсутствует, если **isTenderer**=false;
   * **participations** - количество и сумма учатий в закупках;
   * **bids** - количество предложений в конкурентных закупках;
   * **contracts** - количество и сумма подписанных контрактов;

**ВАЖНО**:
1. Суммы и количество контрактов учитывают действующие и завершенные контракты, по которым прошла оплата. Отмененные, предложенные, отказанные и контракты без оплаты тут не учитываются.
2. tenderer_stats->participations — это сумма предложений (bids) в конкурентных и наград (awards) в неконкурентных закупках (в них отсутствуют bids в принципе). 

Значения основных полей очевидны, **isBuyer** равняется **true**, если этот ЕГРПОУ создавал тендеры, **isTenderer** — если принимал участие (делал предложения, получал награды или контракты, не важно, были ли они отменены или нет).

**Метод также поддерживает множественный запрос** — для этого вместо одного ЕГРПОУ нужно передать список, разделённые запятыми. За один раз метод возвращает до **25** результатов (остальные отбрасываются). 

В случае множественного запроса, результаты будут помещены в объект **list**, ключами которого будут запрошенные ЕГРПОУ. 
В случае, если ЕГРПОУ не найден в базе, значением ключа будет **null**.

Например: https://clarity-project.info/api/edr.info/35601826,1234567890
```
{
  "list": {
    "35601826": {
      "edr": "35601826",
      "name": "ТОВ \"КОНТРАКТ ПРОДРЕЗЕРВ 5\"",
      ...
    },
    "1234567890": null
  },
  "stats": {
    "query_time": 0.011358976364136
  }
}
```

#### /edr.search
Поиск по ЕГРПОУ.

Например: /api/edr.search?q=фоп

GET-параметры: 
* q — запрос;
* page — страница результатов.

Возвращает объект с ключами **paginator** — информация о результатах поиска и **list** — список в том же формате, что и **edr.info**, без полей isBuyer и isTenderer.

**Важно:**
Поиск реально медленный, и занимает **15+ секунд**, иногда просто падая с 504 ошибкой.

#### /edr.history/*ЕГРПОУ*
Возвращает историю изменений информации о ЕГРПОУ.

GET-параметры:
* **categories** — если **1**, то показывать в виде категорий, иначе в виде хронологии. 

#### /edr.relations/*ЕГРПОУ*
Возвращает связи для ЕГРПОУ.

#### /tender.search
Поиск по тендерам. 

Возвращает тендеры по фильтру. 

GET-параметры в том же формате, что и при запросе из [интерфейса](http://clarity-project.info/tenders).
* **text** — поиск по тексту в описании или заголовке тендера;
* **entity** — ЕГРПОУ заказчика;
* **tenderer** — ЕГРПОУ участника;
* **classification** — CPV-код закупки. Из-за бага сейчас от него отрезаются нули, то есть, **30000000-9** становится **3**. Ищется по wildcard, **3411** = **3411....**.
* **tenderer_status** — **tenderer** (сделал ставку), **supplier** (победил), **contractor** (подписан контракт);
* **date_from** и **date_to** — даты последнего обновления данных в тендере, от-до, в формате **dd-mm-yyyy**;
* **value_min** и **value_max** — диапазон **планируемой** цены закупки;
* **method** — открытые/неконкурентные, **open** или **limited**;
* **complaints** — если **1**, то фильтрует по наличию жалоб на тендер;
* **complaint_from** — от кого жалоба, ЕГРПОУ;
* **status** — статус тендера, **active**, **complete**, **unsuccessful**, **cancelled**;
* **region** — область, в которой находится закупщик;
* **risks[]** — рассчитанные для тендера риски, массив;
* **sort** — **Modified** (от новых к старым), **Value** (от дорогих к дешевым), **Economy** (по экономии), **RisksScorePercent** (по рискам);
* **offset** — сколько тендеров пропустить сверху списка.

Поскольку **tender.search** не возвращает объект **paginator**, то пагинация реализуется с помощью параметра **offset**. Если тендеры под фильтрами закончились, метод вернёт пустой массив.

Доступные значения для поля **risks[]**:
```
'FirstCPVCode' => 'Первая закупка по этому CPV',
'TenderersAreRelated' => 'Участники тендера связаны между собой',
'InvalidCPVCode' => 'Неправильный CPV закупки',
'MuchDifferenceInBids' => 'Большая разница в предложениях',
'TendererSuppliesOnlyThisEntity' => 'Поставщик работает только с этим заказчиком',
'TooManyCancelledAwards' => 'Много дисквалификаций',
'WonAllLots' => 'Победитель торгов выиграл все лоты',
'InvalidWinnerEdr' => 'ЕГРПОУ/ИНН победителя не прошел валидацию',
'BidWerentLoweredMuch' => 'Выигрышная ставка была снижена минимально',
'TenderDocsUploadedAfterAuction' => 'Тендерная документация была изменена после аукциона',
'NoTenderDocuments' => 'Тендерная документация отсутствует',
'WrongContractTerms' => 'Нарушены сроки подписания контракта', 
'TendererFirstWin' => 'У победителя тендера это первый выигранный контракт',
'TenderWithoutDescription' => 'Тендер без описания', 
'ShortCPVCode' => 'CPV до 4-х знаков',
'TooManyItems' => 'Слишком много предметов для закупки для этого CPV',
'TooManyLots' => 'Слишком много лотов для этого CPV'
```

**Важно:**
Из-за бага (я буду звать это фичей) offset не работает, если не были переданы другие фильтры. 

